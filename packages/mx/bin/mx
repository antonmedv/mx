#!/usr/bin/env node
const fs = require('fs')
const parser = require('../src/parser')
const drawGraph = require('../src/graph')
const sourceNode = require('../src/compiler/sourceNode')
const compile = require('../src/compiler')
const prettier = require("prettier")

const file = __dirname + '/../test.mx'
const code = fs.readFileSync(file, {encoding: 'utf8'})

const lexer = parser.Parser.prototype.lexer;
lexer.setInput(code)
for(;;) {
  let token = lexer.lex()
  console.log(parser.Parser.prototype.terminals_[token] || token , JSON.stringify(
    lexer.yytext
  ))
  if (token === 1) break
}

const ast = parser.parse(file, code)
//console.log(JSON.stringify(ast, null, 4))
console.log(drawGraph(ast))

let node = sourceNode('')
node.add(compile(file, ast, {}))
//console.log(JSON.stringify(node, null, 4))
let output = node.toStringWithSourceMap({file})

console.log(prettier.format(output.code, {}))
